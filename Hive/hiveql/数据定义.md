## 数据库

Hive中数据库的概念本质上仅仅是表的一个目录或者命名空间。但数据库可以避免表命名冲突，通常会使用数据库来将生产表组织成逻辑组。

**如果用户没有显式指定数据库，那么将会使用默认的数据库default**。

### 创建数据库

示例：【创建一个数据库】

```sql
CREATE DATABASE financials;

-- 避免数据库已经存在，再使用创建语句进行创建的报错情况，可使用以下语句
CREATE DATABASE IF NOT EXISTS financials;
```

在所有的数据库相关的命令中，都可以使用SCHEMA这个关键字来替代关键字TABLE。

查看Hive中所包含的数据库：

```sql
SHOW DATABASES;

-- 可以使用正则表达式匹配来帅选出需要的数据库名，如列出所有以字母h开头，以其他字符结尾的数据库
SHOW DATABASES LIKE 'h.*';
```

Hive会为每个数据库创建一个目录。数据库中的表将会以这个数据库目录的子目录形式存储。有一个例外就是default数据库中的表，因为这个数据库本身没有自己的目录。

数据库所在的目录位于属性`hive.metastore.warehouse.dir`所指定的顶层目录之后。假设用户使用的是这个配置项默认的配置，也就是`/user/hive/warehouse`，那么当用户创建数据库financials时，Hive将会对应地创建一个目录`/user/hive/warehouse/financials.db`。注意，数据库的文件目录名时以`.db`结尾的。

用户可以通过如下的命令来修改这个默认的位置：

```sql
CREATE DATABASE financials LOCATION '/my/preferred/directory';
```

用户也可以为这个数据库添加一个描述信息，这样通过`DESCRIBE DATABASE <database>`命令就可以查看到该信息。

```sql
CREATE DATABASE financials COMMENT 'this is a comment';

DESCRIBE DATABASE financials;
-- financials this is a comment
```

**DESCRIBE DATABASE语句也会显示出这个数据库所在的文件目录位置路径**。

### 使用数据库

USE命令用于将某个数据库设置为用户当前的工作数据库，和在文件系统中切换工作目录时一个概念：

```sql
USE financials;
```

因为在Hive中没有嵌套数据库的概念，所以在Hive中可以重复使用USE命令来切换使用数据库。

### 删除数据库

```sql
DROP DATABASE IF EXISTS financials;
```

IF EXISTS子句时可选的，如果加了这个子句，就可以避免因数据库的不存在而抛出警告信息。

默认情况下，Hive是不允许用户删除一个包含有表的数据库的。用户要么先删除数据库中的表，然后再删除数据库；要么在删除命令的最后面加上关键字CASCADE，这样可以使Hive自行先删除数据库中的表：

```sql
DROP DATABASE IF EXISTS financials CASCADE;
```

如果使用的使RESTRICT这个关键字而不是CASCADE这个关键字的话，那么就和默认情况一样，也就是，如果想删除数据库，那么必须先要删除掉该数据库中的所有表。

如果某个数据库被删除了，那么对应的目录也同时会被删除。

### 修改数据库

用户可以使用`ALTER DATABASE`命令为某个数据库的DBPROPERTIES设置键值对属性值，来描述这个数据库的属性信息。数据库的其他元数据信息是不可更改的，包括数据库名和数据库所在的目录位置：

```sql
ALTER DATABASE financials SET DBPROPERTIES('edited-by'='superz')
```

不能删除或者重置数据库属性。

## 表

### 创建表

CREATE TABLE语句遵从SQL语法惯例，但是Hive的这个语句中具有显著的功能扩展，使其可以具有更广泛的灵活性。

示例：【创建一张employees表】

```sql
CREATE TABLE IF NOT EXISTS mydb.employees(
    name              STRING COMMNET 'Employee name'
    salary            FLOAT COMMENT 'Enployee salary'
    subordinates      ARRAY<STRING> COMMENT 'Names of subordinates'
    deductions        MAP<STRING,FLOAT>
                      COMMENT 'Keys are deductions names,values are percentages'
    address           STRUCT<street:STRING,city:STRING,state:STRING,zip:INT>
                      COMMNET 'Home address'
)
COMMENT 'Description of the table'
TBLPROPERTIES('createor'='superz','create_at'='2019-12-31 15:50:00',...)
LOCATION '/user/hive/warehouse/mydb.db/employees'
```

- 如果当前所处的数据库并非是目标数据库，那么用户可以在表名前增加一个数据库名来进行指定的
- 如果用户添加上可选项IF NOT EXISTS，那么若表已经存在了，Hive就会忽略掉后面执行语句，而且不会有任何提示
- 如果用户使用了IF NOT EXISTS，而且这个已经存在的表和CREATE TABLE语句后指定的模式不同的，Hive会忽略掉这个差异
- 用户可以在字段类型后为每个字段添加一个注释；和数据库一样，用户也可以为这个表本身添加一个注释，还可以自定义一个或多个表属性。大多数情况下，TBLPROPERTIES的主要作用是按键值对的格式为表增加额外的文档说明
- Hive会自动添加两个表属性：一个是last_modified_by，其保存着最后修改这个表的用户的用户名；另一个是last_modified_time，其保存着最后一次修改的时间

用户还可以拷贝一张已经存在的表的表模式（而无需拷贝数据）：

```sql
CREATE TABLE IF NOT EXISTS mydb.employees2 Like mydb.employees
```

### 查看表

`SHOW TABLES`命令可以列举出所有的表，如果不增加其他参数，那么只会显式当前工作数据库下的表。

```sql
SHOW TABLES;
```

即使不在指定数据库下，用户也可以指定数据库下的表：

```sql
SHOW TABLES IN mydb；
```

也可以使用`DESCRIBE employees`来查看单个表的详细，也可以使用`DESCRIBE EXTENDED employees`命令来查看这个表的详细表结构，使用FORMATTED关键字替代EXTENDED关键字的话，可以提供更加可读和冗长的输出信息。

注：实际情况是使用FORMATTED要多谢，因为其输出内容详细而且可读性强。

### 删除表

Hive支持和SQL中DROP TABLE命令类似的操作：

```sh
DROP TABLE IF EXISTS employees;
```

- 对于管理表（内部表），表的元数据信息和表内的数据都会被删除
- 对于外部表，表的元数据信息会被删除，但是表中的数据不会被删除

### 修改表

大多数的表属性可以通过ALTER TABLE语句来进行修改。这种操作会修改元数据，但不会修改数据本身。这些语句可用于修改表模式中出现的错误、该表分区路径以及其他一些操作。

> 注：**ALTER TABLE仅仅会修改表元数据，表数据本身不会有任何修改**。需要用户自己确认所有修改都和真实的数据是一致的。

#### 表重命名

```sh
ALTER TABLE log_messages RENAME TO logmsgs;
```

#### 增加、修改和删除表分区

**增加分区**

`ALTER TABLE table ADD PARTITION ...`语句用于为表（通常是外部表）增加一个新的分区。

示例：

```sh
ALTER TABLE log_messages ADD IF NOT EXISTS
PARTITION(year=2011,month=1,day=1) LOCATION '/logs/2011/01/01'
PARTITION(year=2011,month=1,day=2) LOCATION '/logs/2011/01/02'
PARTITION(year=2011,month=1,day=3) LOCATION '/logs/2011/01/03'
```

**修改分区**

用户可以通过高效地移动位置来修改某个分区的路径：

```sh
ALTER TABLE log_messages PARTITION(year=2011,month=12,day=1)
SET LOCATION '/logs/2011/12/01_modify'
```

上面修改的命令不会将数据从旧的路径转移走，也不会删除旧的数据。

**删除分区**

```sh
ALTER TABLE log_messages DROP IF EXISTS PARTITION(year=2011,month=12,day=2)
```

对于管理表（内部表），即使是使用`ALTER TABLE ... ADD PARTITION`增加的分区，分区内的数据也会同时和元数据信息一起被删除的；对于外部表，分区内数据不会被删除

#### 修改列信息

用户可以对某个字段进行重命名，并修改其位置、类型或者注释：

```sh
ALTER TABLE log_messages
CHANGE COLUMN hms hours_minutes_seconds INT
COMMENT 'The hours,minutes,and seconds part of the timestamp'
AFTER severity
```

即使字段名或者字段类型没有改变，用户也需要完全指定旧的字段名，并给出新的字段名及新的字段类型。关键字COLUMN和COMMENT子句是可选的。上例中将字段转移到severity字段之后，如果用户想将这个字段移动到第一个位置，那么只需要使用FIRST关键字替代AFTER `other_column`子句即可

#### 增加列

用户可以在分区字段之前增加新的字段到已有的字段之后

```sh
ALTER TABLE log_messages ADD COLUMNS(
    app_name STRING COMMENT 'Application name',
    session_id LONG COMMENT 'The current session id'
);
```

如果新增的字段中有某个或多个字段位置是错误的，那么需要使用`ALTER COLUMN 表名 CHANGE COLUMN`语句逐一将字段调整到正确的位置。

#### 删除或者替换列

示例：【移处之前所有的字段并重新指定新的字段】

```sh
ALTER TABLE log_messages REPLACE COLUMNS(
   hours_mins_secs INT COMMENT 'hour,minute,seconds from timestamp',
   severity STRING COMMENT 'The message severity',
   message STRING COMMENT 'Thre rest of the message'
)
```

#### 修改表属性

用户可以增加附加的表属性或者修改已经存在的属性，但是无法删除属性：

```sh
ALTER TABLE log_messages SET TBLPROPERTIES(
    'notes'='The process id is no longer captured;this column is always NULL');
```