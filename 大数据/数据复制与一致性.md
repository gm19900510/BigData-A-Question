# 数据复制与一致性

## 基本原理与设计理念

### CAP

> CAP 是对 "Consistency/Availability/Partition Tolerance" 的一种简称，其分别代表：强一致性、可用性和分区容忍性，三特征的内在含义如下：
>
> - **强制一致性**：即在分布式系统中的同一数据多副本情况下，对于数据的更新操作体现出的效果与只有单份数据是一样的
> - **可用性**：客户端在任何时刻对大规模数据的读/写操作都应该保证在限定延时内完成
> - **分区容忍性**：在大规模分布式系统中，网络分区现象，即分区间的机器无法进行网络通信的情况是必然会发生的，所以系统应该能够在这种情况下仍然继续工作

对于一个大规模分布式数据系统来说，CAP 三要素不可兼得，同一系统至多只能实现其中的两个，而必须放宽第 3 个要素来保证其他两个要素被满足。一般在网络环境下，运行环境出现网络分区是不可避免的，所以系统必须具备分区容忍性，于是一般在此种场景下设计大规模分布式系统时，架构师往往在 AP 和 CP 中进行权衡和选择，有所强调，有所放弃。

在假设存在网络分区的情形下，若已得到 P，那么 A 和 C 是否可以兼得。可以分为两种情形来进行进一步推演：

![image-20200405225210010](https://i.loli.net/2020/04/05/mykF5dC7eSL2XPj.png)

![image-20200405225343605](https://i.loli.net/2020/04/05/QKYgk6xqNTZdnLJ.png)

综上所述，在分布式环境下 CAP 是不可兼得的。

> 在 2012 年 CAP 的作者对此理论提出了质疑【具体网上参见】，针对 CAP 理论的误导性，提出了如下的应用 CAP 策略：在绝大多数系统未产生网络分区的情况下，应该尽可能保证 AC 两者兼得，也即大多数情况下考虑 CAP 三者兼得，当发生网络分区时，系统应该能够识别这种状况并对其进行正确处理，具体而言可分为 3 个步骤：首先能够识别网络分区发生，然后在网络分区场景下进入明确的分区模式，此时可能会限制某些系统操作，最后在网络分区解决后能够进行善后处理，即恢复数据的一致性或者弥补分区模式中产生的错误。

![image-20200405231148908](https://i.loli.net/2020/04/05/lwV7QreRztIavLp.png)

上图给出了对传统 CAP 的实际应用进行修正后的示意图。在系统各种操作进行过程中，整个系统状态保持一致（状态 $S$），即整个系统满足 CAP 三要素。当发生网络分区后，系统识别出此种情形并明确记载各个分区的各自状态。为了保证可用性，每个分区进入分区模式并各自执行本分区内的各种操作，此时产生了两个分区模式下的状态 $S_{1}$ 和 $S_{2}$ ，这两个状态是不一致的，即整个系统满足 AP 要素。当网络分区解决后，整个系统转入分区恢复状态，在恢复过程中，融合  $S_{1}$ 和 $S_{2}$ 形成新的满足一致性要求的新状态 $S'$，此时系统再次进入满足 CAP 要素的状态。

### ACID 原则

> 事务满足 ACID 原则，ACID 是 "Atomicity/Consistency/Isolation/Durability" 的简写，分别代表原子性、一致性、隔离性、持久性

### BASE 原则

> BASE 原则是指：
>
> - **基本可用**（Basically Available）：在绝大多数时间内系统处于可用状态，允许偶尔的失败，所以称为基本可用
> - **软状态或者柔软状态**（Soft State）：是指数据状态不要求在任意时刻都保持同步，到目前为止软状态并无一个明晰的定义，但是从概念上是可理解的，即处于有状态（State）和无状态（Stateless）之间的中间状态
> - **最终一致性**（Eventual Consistency）：与强一致性相比，最终一致性是一种弱一致性，尽管软状态不要求任意时刻数据保持一致同步，但是最终一致性要求在给定时间窗口内数据会达到一致状态。

### 幂等性（Idempotent）

> 分布式系统中的幂等性是指：调用方反复执行同一操作与只正确执行一次操作效果相同，即对分布式系统内部状态来说，同一操作调用一次与反复调用多次其状态保持相同。在分布式环境下，系统具有幂等性很重要，因为分布式环境下调用方和被调用方往往需要通过网络通信，如果调用方已经正确调用服务方提供的功能，但是由于网络故障，调用方并未收到调用成功的响应，会认为调用失败从而再次调用相同操作，这样被调用方反复执行同一操作，在此种情形下，保持幂等性可以保证系统状态的正确性。

## 一致性模型分类

一致性模型包括：

- 强一致性
- 弱一致性
- 最终一致性
- 因果一致性
- “读你所写”一致性
- 会话一致性
- 单调读一致性
- 单调写一致性

![image-20200405235435885](https://i.loli.net/2020/04/05/b2QaFn7SAPgce6C.png)

## 副本更新策略

一般大规模分布式存储系统会将一份数据在系统内复制多份并放置在不同的机器存储，这样一方面通过数据冗余来增加系统可用性，另一方面也可以增加读操作的并发程度。因此在多副本场景下，副本更新策略可能有以下 3 种：**同时更新策略**、**主从式更新策略**及**任意节点更新策略**。

## 一致性协议

### 两阶段提交协议（Two-Phrase Commit，2PC）

两阶段提交协议是常用的解决分布式事务问题的方式，它可以保证在分布式事务种，要么所有参与进程都提交事务，要么都取消事务，即实现 ACID 中的原子性（A）的常用手段。在数据一致性环境下，其代表的含义是：要么所有备份数据同时更改某个值，要么都不更改，以此来达到数据的强一致性。

在两阶段提交的语境下，存在两类不同实体：**唯一的协调者**（Coordinator）和众多的**参与者**（Participants）。协调者起到分布式事务的特殊的管理协调作用。

两阶段提交将提交过程划分为连续的两个阶段：**表决阶段**（Voting）和**提交阶段**（Commit）。假设在没有故障发生的情形下，两阶段提交协议由下列操作序列构成：

![image-20200406001751710](https://i.loli.net/2020/04/06/PAHZSuN2JpDgFca.png)



### 向量时钟（Vector Clock）

TODO

### RWN 协议

这是一种通过对分布式环境下多备份数据如何读/写成功进行配置来保证达到数据一致性的简明分析和约束设置。

RWN 的相关定义：

- N：在分布式存储系统中，有多少份备份数据
- W：代表一次性成功的更新操作要求至少有 W 份数据写入成功
- R：代表一次性成功的读数据操作要求至少有 R 份数据成功读取

如果能够满足以下公式，则可称为满足 "数据一致性协议"：

$$R+W>N$$

如果满足上述公式的要求，说明成功写入的备份集合和成功读取的备份集合一定会存在交集，而这就可以保证数据的强一致性，即读取操作一定可以读到最新的数据版本。

### Paxos 协议

TODO

### Raft 协议

TODO