# 集群资源管理与调度

## 资源管理抽象模型

### 概念模型

资源管理调度概念模型如下图所示：

![image-20200406210610510](https://i.loli.net/2020/04/06/RyTV8YHm4UzsbiK.png)

上图展示了一个抽象的资源管理与调度系统的概念模型。从概念上讲，资源管理与调度系统的主要目的是将集群中的各种资源通过一定策略分配给用户提交到系统里的各种任务，常见的资源主要包括内存、CPU、网络资源与磁盘 I/O 资源 4 类。而这个概念模型主要强调**三要素：资源组织模型、调度策略和任务组织模型**。不同的资源管理与调度系统基本遵循上述概念模型，但是具体在三要素的实现方式上有差异。

资源组织模型的主要目的是将集群中当前可用的各种资源采用一定的方式组织起来，以方便后续的资源分配过程。一个常见的资源组织方式是将资源组织成多层级队列的方式，比如 Facebook 的 Corona 将资源组织模型建为 “all-resource -> group -> pool” 三级队列结构。平级多对别以及单队列也是非常常见的资源组织模型，可以将其看作多层级队列结构的特殊组织形式。

任务组织模型的主要目标是将多用户提交的多任务通过一定方式组织起来，以方便后续资源分配。

### 通用架构

![image-20200406213223744](https://i.loli.net/2020/04/06/37aTKVcFvi6Hz1L.png)

上图展示了一个从各个实际资源管理调度系统中抽象出来的通用资源管理框架。

由上图可知，集群中每台机器上会配置节点管理器，其主要职责是不断的向资源收集器汇报目前本机资源使用状况，并负责容器的管理工作。当某个任务被分配到本节点执行时，节点管理器负责将其纳入某个容器执行并对该容器进行资源隔离，以避免不同容器内任务的互相干扰。

通用调度器由资源收集器和资源调度策略构成，同时管理资源池和工作队列数据结构。资源收集器不断地从集群内各个节点收集和更新资源状态信息，并将其最新状况反映到资源池中，资源池列出了目前可用的系统资源。资源调度策略是具体决定如何将资源池中的可用资源分配给工作队列的方法，常见的策略包括 FIFO、公平调度策略和能力调度策略等。资源调度策略模块往往是可插拔的，实际系统应用者可以根据情况设定符合业务状况的调度策略。当用户新提交作业时，其进入工作队列等待分配使其可启动的资源。

## 资源调度策略

### FIFO 调度策略

FIFO 策略是最简单的资源调度策略，提交的作业按照提交时间先后顺序或者根据优先级次序将其放入线性队列相应位置，在资源调度时按照队列先后顺序，先进先出地进行调度与资源分配。FIFO 是 Hadoop 默认的调度策略，在多用户场景下，新加入的的作业很容易出现长时间等待调度现象。

### 公平调度器（Fair Scheduler）

公平调度器是 Facebook 为 Hadoop 开发的多用户多作业调度器。其将用户的任务分配到多个资源池（Pool），每个资源池设定资源分配最低保障和最高上限，管理员也可以指定资源池的优先级，优先级高的资源池会被分配更多的资源，当一个资源池资源有剩余时，可以临时将剩余资源共享给其他资源池。

公平调度器的调度过程如下：

1. 首先，根据每个资源池的最小资源保障量，将系统中的部分资源分配给各个资源池
2. 其次，根据资源池的指定优先级将剩余资源按照比列分配给各个资源池
3. 最后，在各个资源池中，按照作业优先级或者根据公平策略将资源分配给各个作业

公平调度器和能力调度器都是 Hadoop 常用的调度策略，与能力调度器相比，公平调度器有两个明显的区别：

- 其一，公平调度器支持抢占式调度，即如果某个资源池长时间未能被分配到公平共享量的资源，则调度器可以杀死过多分配资源的资源池中的任务，以空出资源供这个资源池使用
- 其二，公平调度器更强调作业间的公平性。在每个资源池中，公平调度器默认使用公平策略来实现资源分配，这种公平策略是最大最小公平算法（Max-min fairness）的一种具体实现，可以尽可能保证作业间的资源分配公平性。

### 能力调度器（Capacity Scheduler）

能力调度器是 Yahoo 为 Hadoop 开发的多用户调度器，适合用户量众多的应用场景，与公平调度器相比，其更强调资源在用户之间而非作业之间的公平性。

它将用户和任务组织成多个队列，每个队列可以设定资源最低保障和使用上限，当一个队列的资源有剩余时，可以将剩余资源暂时分享给其他队列。调度器在调度时，优先将资源分配给资源使用率最低的队列（即队列已使用资源量占分配给队列的资源量比列最小的队列）；在队列内部，则按照作业优先级的顺序遵循 FIFO 策略进行调度。

