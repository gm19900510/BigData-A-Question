# 数据分片与路由

对于海量存储的数据，对于单机基本无法进行处理掉，此时需要通过**数据分片**（Shard/Partition）来将数据进行切分并分配到各个机器中去，数据分片后，如何能够找到某条记录的存储位置就称为必然要解决的问题，这一般被称为**数据路由**（Routing）。

常见的数据分片方法包括 **哈希分片** 和 **范围分片**。

## 抽象模型

![image-20200405135715653](https://i.loli.net/2020/04/05/nI7Y8LVFPbNABk2.png)

上图展示了一个具有很高抽象级别的数据分片与路由通用模型，可以看作是一个二级映射关系，第一级映射是 key-partition 映射，其将数据记录映射到数据分片空间，这往往是多对一的映射关系，即一个数据分片包含多条记录数据；第二级映射是 partition-machine 映射，其将数据分片映射到物理机器中，这一般也是多对一映射关系，即一台物理机容纳多个数据分片。

在做数据分片时，根据 key-partition 映射关系将大数据水平切割成众多数据分片，然后再按照 partition-machine 映射关系将数据分片放置到对应的物理机器上。而在做数据路由时，比如要查找某条记录的值 `Get(Key)`，首先根据 key-partition 映射找到对应的数据分片，然后再查找 partition-machine 关系表，就可以知道具体哪台物理机器存储该条数据，之后即可从相应物理机读取 key 的对应 value 内容。

## 哈希分片

通过哈希函数来进行数据分片是常见手段，其中最常见的 3 种哈希分片方式分别是：Round Robin、虚拟桶及一致性哈希方法。

### Round Robin

Round Robin 就是俗称的哈希取模法。

假设有 K 台物理机，通过以下哈希函数即可实现数据分片：

$$H(key)=hash(key) mod K$$

对物理机进行编号从 0 到 K-1，根据上述哈希函数，对于以 key 为主键的某个记录，$H(key)$ 的数值即是存储该数据的物理机编号，通过这种方式，就将全部数据分配到 K 台物理机上，在查找某条记录时，也使用同样的哈希函数就可以找到存储相应信息的物理机。

Round Robin 的优点是实现起来非常简单，但是缺乏灵活性，当新增一台物理机，以前计算的数据映射都不可用，需要重新计算。

### 虚拟桶（Virtual Buckets）

虚拟桶就是数据记录和物理机之间引入的一层，所有记录首先通过哈希函数映射到对应的虚拟桶，记录和虚拟桶是多对一的映射关系，即一个虚拟桶包含多条记录信息；第二层映射是虚拟桶和物理机之间的映射关系，同样也是多对一映射，一个物理机可以容纳多个虚拟桶。

相比于 Round Robin，Virtual Buckets 将原先由记录直接到物理机的单层映射解耦成两级映射，大大加强了系统的扩展灵活性。当新加入机器时，将某些虚拟桶从原先分配的机器重新分配给新机器，只需要修改 partition-machine 映射表中受影响的个别条目就能实现扩展，具有较强的灵活性。

### 一致性哈希（Consistent Hashing）

TODO

## 范围分片

范围分片首先将所有记录的主键进行排序，然后在排好序的主键空间里将记录划分成数据分片，每个数据分片存储有序的主键空间片段内的所有记录。在实现具体存储系统时，往往保持一个数据分片的映射表，记录表每一项记载数据分片的最小主键及其对应的物理地址，如下图所示：

![image-20200405221821166](https://i.loli.net/2020/04/05/wLKPFUh876tmTln.png)